### toy-koa
手写实现一个简易的 koa 框架

### 思路
1. koa 其实就是一个`class`，对外提供`use`、`listen`方法，以及包装了`ctx`、`中间件`概念，主要难点也在这两个地方
2. 对于`ctx`，其实就是在原生`res`、`req`的基础上进行扩展，并集合到`ctx`对象上
3. 对于`中间件`，koa实现的是`洋葱模型`，利用发布订阅模式和递归函数，实现中间件和`next`机制

### koa 与 express 的区别
1. 整体的架构上：express 集成了很多的功能，例如 Router 等，而作为原班人马打造框架，koa 则是更轻量简洁，更加高可定制的框架，同时也提供了一些官方工具库。
2. 中间件机制：koa 是有名的“洋葱模型”，像洋葱一样一层层进入再一层层出来，同步和异步都严格遵循“洋葱模型”机制，koa1的中间件异步处理用的是`Generator + co`，koa2的中间件异步处理用的是异步的终极解决方案`async await`，基于的是`Promise`。而 express 可以说是“伪洋葱模型”，在同步逻辑下，express 的中间件机制也遵循“洋葱模型”机制，一层层进入，再一层层出来。但在异步情况下，所谓的“洋葱模型”机制就会变得奇怪，即使用了`async await`语法调用，也不是像 koa 那样执行，因为 express 处理异步中间件的方法是`Callback`，也就是回调，所以下一个中间件不会等待上一个中间件执行完毕再进入。
3. 响应机制：express 是一旦`res.send`，那就会`立即响应`，立刻将请求结果响应给客户端，所以后面的中间件逻辑就没什么用处了，在多个中间件里多次地`res.send`的话，只有第一个会响应给服务端，并且后面的逻辑中`res.send`在 node 进程中会抛出`ERR_HTTP_HEADERS_SENT`错误。koa 不是在`ctx.body = xxx`，后立即响应，而是在`所有中间件都执行完之后`，在最外层进行了响应，所以可以在多个中间件里多次地`ctx.body += xxx`

### 参考
1. [node进阶——之事无巨细手写koa源码](https://juejin.cn/post/6844903682799042568)
2. [多维度分析 Express、Koa 之间的区别](https://zhuanlan.zhihu.com/p/115339314)